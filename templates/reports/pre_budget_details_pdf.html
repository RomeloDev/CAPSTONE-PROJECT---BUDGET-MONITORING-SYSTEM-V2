{% extends "reports/report_template.html" %}
{% load humanize %}

{% block report_content %}
<style>
    /* Landscape Override */
    @page {
        size: A4 landscape;
        margin: 0.5in;
        margin-top: 0.5in;
    }
    .data-table th {
        font-size: 9pt;
        padding: 3px;
    }
    .data-table td {
        font-size: 9pt;
        padding: 3px;
    }
    .q-header {
        background-color: #e6f3ff !important;
    }
    .sub-header {
        font-size: 8pt;
        font-weight: normal;
    }
    .pre-section {
        margin-bottom: 30px;
        page-break-inside: avoid;
    }
    .pre-header {
        background-color: #f8fafc;
        border: 1px solid #e2e8f0;
        padding: 10px;
        margin-bottom: 10px;
        font-size: 10pt;
    }
</style>

<div class="report-title">
    <span style="font-size: 10pt; font-weight: normal;">Fiscal Year: {{ selected_year }}</span>
</div>

<div class="meta-info">
    <strong>Generated By:</strong> {{ generated_by }} <br>
    <strong>Date Generated:</strong> {{ date_generated }}
</div>

{% for data in pre_data %}
<div class="pre-section">
    <div class="pre-header">
        <strong>Department:</strong> {{ data.department }} | 
        <strong>Status:</strong> {{ data.status }} | 
        <strong>Total Budget:</strong> Php {{ data.total_amount|floatformat:2|intcomma }} | 
        <strong>Remaining:</strong> Php {{ data.total_remaining|floatformat:2|intcomma }}
    </div>

    <table class="data-table">
        <thead>
            <tr>
                <th rowspan="2" style="width: 20%; text-align: left; vertical-align: middle;">Line Item / Category</th>
                <th colspan="3" class="q-header">Q1</th>
                <th colspan="3">Q2</th>
                <th colspan="3" class="q-header">Q3</th>
                <th colspan="3">Q4</th>
                <th colspan="3" class="q-header">Total</th>
            </tr>
            <tr>
                <!-- Q1 -->
                <th class="sub-header q-header">Alloc</th>
                <th class="sub-header q-header">Used</th>
                <th class="sub-header q-header">Bal</th>
                <!-- Q2 -->
                <th class="sub-header">Alloc</th>
                <th class="sub-header">Used</th>
                <th class="sub-header">Bal</th>
                <!-- Q3 -->
                <th class="sub-header q-header">Alloc</th>
                <th class="sub-header q-header">Used</th>
                <th class="sub-header q-header">Bal</th>
                <!-- Q4 -->
                <th class="sub-header">Alloc</th>
                <th class="sub-header">Used</th>
                <th class="sub-header">Bal</th>
                <!-- Total -->
                <th class="sub-header q-header">Alloc</th>
                <th class="sub-header q-header">Used</th>
                <th class="sub-header q-header">Bal</th>
            </tr>
        </thead>
        <tbody>
            {% for row in data.line_items %}
            <tr>
                <td style="text-align: left;">
                    <strong>{{ row.item_name }}</strong><br>
                    <span style="color: #666; font-size: 8pt;">{{ row.category }}</span>
                </td>
                
                <!-- Q1 -->
                <td style="text-align: right; background-color: #f0f7ff;">{{ row.quarters.Q1.budgeted|floatformat:0|intcomma }}</td>
                <td style="text-align: right; background-color: #f0f7ff;">{{ row.quarters.Q1.consumed|floatformat:0|intcomma }}</td>
                <td style="text-align: right; background-color: #f0f7ff;">{{ row.quarters.Q1.available|floatformat:0|intcomma }}</td>

                <!-- Q2 -->
                <td style="text-align: right;">{{ row.quarters.Q2.budgeted|floatformat:0|intcomma }}</td>
                <td style="text-align: right;">{{ row.quarters.Q2.consumed|floatformat:0|intcomma }}</td>
                <td style="text-align: right;">{{ row.quarters.Q2.available|floatformat:0|intcomma }}</td>

                <!-- Q3 -->
                <td style="text-align: right; background-color: #f0f7ff;">{{ row.quarters.Q3.budgeted|floatformat:0|intcomma }}</td>
                <td style="text-align: right; background-color: #f0f7ff;">{{ row.quarters.Q3.consumed|floatformat:0|intcomma }}</td>
                <td style="text-align: right; background-color: #f0f7ff;">{{ row.quarters.Q3.available|floatformat:0|intcomma }}</td>

                <!-- Q4 -->
                <td style="text-align: right;">{{ row.quarters.Q4.budgeted|floatformat:0|intcomma }}</td>
                <td style="text-align: right;">{{ row.quarters.Q4.consumed|floatformat:0|intcomma }}</td>
                <td style="text-align: right;">{{ row.quarters.Q4.available|floatformat:0|intcomma }}</td>

                <!-- Total -->
                <td style="text-align: right; font-weight: bold; background-color: #e6f3ff;">{{ row.total_budgeted|floatformat:0|intcomma }}</td>
                <td style="text-align: right; font-weight: bold; background-color: #e6f3ff;">{{ row.total_consumed|floatformat:0|intcomma }}</td>
                <td style="text-align: right; font-weight: bold; background-color: #e6f3ff;">{{ row.total_available|floatformat:0|intcomma }}</td>
            </tr>
            {% endfor %}
            <tr class="total-row">
                <td style="text-align: right;">TOTAL CHECK</td>
                <td colspan="12"></td>
                <td style="text-align: right;">Php {{ data.total_amount|floatformat:2|intcomma }}</td>
                <td style="text-align: right;">Php {{ data.total_consumed|floatformat:2|intcomma }}</td>
                <td style="text-align: right;">Php {{ data.total_remaining|floatformat:2|intcomma }}</td>
            </tr>
        </tbody>
    </table>
    <div style="font-size: 8pt; margin-bottom: 20px;">* Used = Consumed + Reserved (Pending Requests)</div>
</div>
{% empty %}
<div class="pre-section">
    <p style="text-align: center; padding: 20px;">No approved PRE data found for the selected fiscal year.</p>
</div>
{% endfor %}

{% endblock report_content %}
